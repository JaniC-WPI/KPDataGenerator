# KPDataGenerator with DREAM
This repository details the process of identifying keypoints on different joint locatoions on a robot body and collecting data accordingly. The codes represent data collection process for Franka arm which can be further generalized for other manipulators.

## Pre-requisites 
- 1. We assume that the user of this repo will have a manipulator and camera with respective ROS wrappers. 
- 2. Create a catkin workspace <catkin_ws>
- 3. Clone this repository inside ```~/catkin/src```
- 4. Navigate to ~/catkin_ws and run ```catkin_make```

## Pipeline overview
<img src="https://github.com/JaniC-WPI/KPDataGenerator/blob/master/dream/data_collection_pipeline_block_diagram.png" alt="Alt text" title="Block Diagram">


## Run the repo for Franka Arm
Our data collection pipeline followed the steps detailed below:
- 1. We run [DREAM](https://github.com/NVlabs/DREAM) pipeline to capture the Camera Extrinsics for a certain camera pose. (Users have the liberty to use any form of camera calibration technique)
- 2. In the main function for script ```kp_detection_full.py``` we have variables `tvec` and `quat`. We assign the Camera Extrinsics that is the translational component of the Camera World Pose to **'tvec'** and rotational component to **'quat'**. 
- 3. We have a launch file ```dream_depth_ds_gen_full.launch``` with the scripts ```kp_detection_full.py```. This launch file also includes the launch file for realsense2_camera which we used for our data collection. 
- 4. We also have a script ```franka_vel_pub_test.py```, for moving the Franka arm to arbitrary locations in the launch file  
- 5. Start the controller for Franka and connect the camera
- 6. Run the following command to run the entire pipeline:-
    ```
    $ roslaunch <package_name> dream_depth_ds_gen_full.launch
    ```
 Running the pipeline will save a number of images and corresponding annotated json files in a folder with current_date as the folder name. Following image and json script is a sample data that is generated by this pipeline. The json file contains 10 keypoints and 10 bounding boxes for relevant joint locations at a specific robot configuration. Further details about the process of keypoint identification can be found in the paper link.
 
 <img src="https://github.com/JaniC-WPI/KPDataGenerator/blob/master/dream/sample_image.png" alt="Alt text" title="Sample Image">```
 ```
 {
    "id": 897,<br>
    "image_rgb": "000897.rgb.jpg",<br>
    "bboxes": [
        [269.3287503494668, 404.37420417148, 289.3287503494668, 424.37420417148],
        [266.6799207638364, 292.44542697801563, 286.6799207638364, 312.44542697801563],
        [249.48124504518523, 190.33305712750948, 269.48124504518523, 210.33305712750948],
        [274.7581009597627, 184.64644505138133, 294.7581009597627, 204.64644505138133],
        [405.513941193429, 175.24921979029767, 425.513941193429, 195.24921979029767],
        [436.33729934578105, 168.1752442805069, 456.33729934578105, 188.1752442805069],
        [476.248986004589, 198.69040529666674, 496.248986004589, 218.69040529666674],
        [412.1812597605679, 210.9391809017749, 432.1812597605679, 230.9391809017749],
        [465.43534757619994, 234.48159405389336, 485.43534757619994, 254.48159405389336],
        [436.4831059469089, 239.89902923224508, 456.4831059469089, 259.8990292322451]
    ],
    "keypoints": [
        [[279.3287503494668, 414.37420417148, 1]],
        [[276.6799207638364, 302.44542697801563, 1]],
        [[259.48124504518523, 200.33305712750948, 1]],
        [[284.7581009597627, 194.64644505138133, 1]],
        [[415.513941193429, 185.24921979029767, 1]],
        [[446.33729934578105, 178.1752442805069, 1]],
        [[486.248986004589, 208.69040529666674, 1]],
        [[422.1812597605679, 220.9391809017749, 1]],
        [[475.43534757619994, 244.48159405389336, 1]],
        [[446.4831059469089, 249.89902923224508, 1]]
    ]
}
```
## How to generalize the given code for any other manipulators
- Modify DH_params variable in ```DH_v2.py``` inside scripts folder depending on the manipulator
- Modify the joints variable in the above file with the joints relevant to the manipulator
- Modify the functions ```world_coords_tf```,  ```image_pixels```, ```kp_gen``` in the script ```kp_detection_full.py``` following way
    - ```world_coords_tf``` returns the positions and orientations(poses) of each joint in the world frame. In this code **p_j0....p_jn** defines the poses for each joint and can be modified on the basis of manipulator
    - ```image_pixels``` return the pixel position of each joint in image space. In this code the variables **image_pix0....image_pixn** defines the pixel positions and can be modified on the number of joints depending on manipulators
    - ```kp_gen``` uses the output from ```image_pixels``` and ```world_coords_tf```, hence need to be modified accordingly
   
 ## Application
 Please check the [video](https://youtu.be/dFXJKEph4dw) for applications of keypoint identification on robotic manipulator

